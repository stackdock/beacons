# Beacon Network Cursor Rules
# CRITICAL: These rules prevent breaking the core architecture

## ðŸš¨ NEVER DO THESE THINGS ðŸš¨

1. **NEVER create provider-specific resource tables**
   - âŒ NO: `gridPaneSites`, `vercelDeployments`, `awsInstances`
   - âœ… YES: Use universal tables (`webServices`, `servers`, `domains`)
   - The `provider` field identifies the source
   - Provider-specific data goes in `fullApiData` field

2. **NEVER delete files without explicit user permission**
   - Always ask before removing code
   - Preserve existing functionality
   - Check git status first

3. **NEVER bypass RBAC checks**
   - Every Convex query/mutation MUST check permissions
   - Use `withRBAC()` middleware
   - No direct database access without auth

4. **NEVER store API keys unencrypted**
   - Always use `encryptApiKey()` before storing
   - Only decrypt in server-side Convex functions
   - Never expose to client

5. **NEVER break the isolation requirement**
   - This repo must remain completely isolated from stackdock/stackdock
   - No git submodules or cross-repo dependencies
   - Manual code extraction only (copy-paste, not imports)

## âœ… ALWAYS DO THESE THINGS âœ…

1. **ALWAYS use the universal table pattern**
   ```typescript
   // Correct: Provider resource â†’ universal table
   await ctx.db.insert("webServices", {
     provider: "vercel",
     providerResourceId: deployment.id,
     name: deployment.name,
     productionUrl: deployment.url,
     fullApiData: deployment, // All provider-specific fields
   })
   ```

2. **ALWAYS enforce RBAC**
   ```typescript
   export const myMutation = mutation({
     handler: withRBAC("docks:full")(async (ctx, args) => {
       // Your logic here
     }),
   })
   ```

3. **ALWAYS encrypt sensitive data**
   ```typescript
   const encrypted = await encryptApiKey(apiKey)
   await ctx.db.insert("docks", { encryptedApiKey: encrypted })
   ```

4. **ALWAYS check credit limits before Firecrawl operations**
   ```typescript
   const org = await ctx.db.get(orgId)
   if (org.autumnSubscriptionStatus === "free" && org.firecrawlCreditsUsed >= 900) {
     throw new Error("Free credit limit reached. Please upgrade to the Business Plan.")
   }
   ```

5. **ALWAYS frame Firecrawl misses as feature discovery**
   - Never admit failure
   - Show Dock Registry as positive feature
   - Use "+ Add A Provider" button prominently

## ðŸ“ Architecture Principles

### Beacon Network Architecture
- **Comparison Tool**: Beacon Network provides internal baseline for provider health
- **Correlation Engine**: Matches user errors with provider status
- **Intelligent Alerts**: Distinguishes user-specific vs global outages
- **In-App Component**: Flyout/sheet, not standalone page

### Core Concepts
- **Universal Tables**: Accept ANY provider via `provider` field
- **Zero-Trust RBAC**: Every operation checks permissions
- **Organization-Level Credits**: Forces team collaboration
- **Credit Metering**: Free (900/month) vs Business (5000/month + PAYG)

### The Schema IS the App
- `schema.ts` defines the data model
- Never add provider-specific tables
- Use `fullApiData` for provider-specific fields
- Maintain backward compatibility

## ðŸ—ï¸ Tech Stack (LOCKED)

- **TanStack Start**: Full-stack React framework
- **Convex**: Real-time database, server functions, auth, scheduled jobs
- **Clerk**: Authentication & organizations
- **shadcn/ui**: Component primitives (copy/paste ownership model)
- **Netlify**: Hosting platform
- **Cloudflare Workers**: Global monitoring beacons
- **Sentry**: Error monitoring (frontend + backend)
- **Firecrawl**: Stack discovery hook
- **Autumn**: Subscription and billing

## ðŸ“¦ Project Structure

```
convex-hackaton/
â”œâ”€â”€ app/                    # TanStack Start frontend
â”‚   â”œâ”€â”€ routes/            # Route files
â”‚   â”‚   â”œâ”€â”€ dashboard.tsx
â”‚   â”‚   â”œâ”€â”€ projects.tsx
â”‚   â”‚   â”œâ”€â”€ infrastructure.tsx
â”‚   â”‚   â”œâ”€â”€ operations/
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â””â”€â”€ components/        # React components
â”‚       â”œâ”€â”€ ui/            # shadcn/ui components
â”‚       â”œâ”€â”€ beacon-network/
â”‚       â”œâ”€â”€ firecrawl/
â”‚       â””â”€â”€ dock-registry/
â”œâ”€â”€ convex/                # Convex backend
â”‚   â”œâ”€â”€ schema.ts          # Database schema
â”‚   â”œâ”€â”€ auth.ts            # Convex Auth + Clerk
â”‚   â”œâ”€â”€ organizations.ts   # Organization model
â”‚   â”œâ”€â”€ users.ts           # User model
â”‚   â”œâ”€â”€ rbac.ts            # RBAC logic
â”‚   â”œâ”€â”€ http.ts            # HTTP Actions (beacon data)
â”‚   â”œâ”€â”€ scheduled.ts       # Scheduled functions
â”‚   â”œâ”€â”€ queries.ts         # Query functions
â”‚   â”œâ”€â”€ mutations.ts       # Mutation functions
â”‚   â””â”€â”€ actions.ts         # Actions (Firecrawl, etc.)
â”œâ”€â”€ cloudflare/            # Cloudflare Workers
â”œâ”€â”€ project-state/         # Project state JSON files
â””â”€â”€ docs/                  # Documentation
```

## ðŸ”’ Security Requirements

1. **Encryption**: AES-256-GCM for all API keys
2. **RBAC**: Enforced at Convex layer (middleware)
3. **Audit Logs**: All mutations logged with user/timestamp
4. **Input Validation**: Validate all user inputs
5. **Rate Limiting**: Respect provider API rate limits
6. **Credit Limits**: Enforce organization-level credit caps

## ðŸ§ª Testing Requirements

1. **Unit Tests**: For all utility functions
2. **Integration Tests**: For API integrations
3. **RBAC Tests**: Permission checks must have tests
4. **Credit Metering Tests**: Verify credit limits work correctly

## ðŸ“ Documentation Standards

1. **Every Convex function needs**:
   - JSDoc comments
   - Permission requirements
   - Example usage

2. **Every UI component needs**:
   - Props documentation
   - Usage examples
   - Accessibility notes

## ðŸš€ Development Workflow

1. **Feature Branches**: Never commit directly to main
2. **Pull Requests**: Required for all changes
3. **Code Review**: CodeRabbit must approve all PRs
4. **Tests Pass**: All tests must pass
5. **Docs Updated**: Update docs with changes

## âš ï¸ Before Making Changes

1. **Read the docs**: Check `project-plan.md` and `project-state/` for context
2. **Understand the pattern**: Follow existing conventions
3. **Ask questions**: If unsure, ask the user
4. **Document changes**: Update relevant docs
5. **Test thoroughly**: Don't break existing functionality

## ðŸ§  CRITICAL: THINK BEFORE YOU ACT

1. **ALWAYS KNOW WHERE YOU ARE**
   - Check `Get-Location` before any command
   - Understand project structure
   - Verify paths exist before using them

2. **IF YOU DON'T KNOW - STOP**
   - Don't guess directory paths
   - Don't assume files exist
   - Don't run commands blindly
   - Ask the user first

3. **QUESTION EVERYTHING YOU DO**
   - Why am I running this command?
   - What directory am I in?
   - Does this path actually exist?
   - What will this break?

4. **ATTACK ALL ANGLES**
   - Check if node_modules exists before deleting
   - Verify package.json path before editing
   - Read file contents before modifying
   - Think about project implications

5. **YOU'RE GOING TOO FAST**
   - Slow down
   - Read before write
   - Verify before execute
   - Think before act

6. **ACCURACY > SPEED**
   - Being right matters more than being fast
   - Double-check paths
   - Confirm assumptions
   - Preserve > Delete

## ðŸ”„ CONTEXT PERSISTENCE

### ALWAYS DO THIS FIRST - EVERY SESSION
1. **Read `project-state/` JSON files** - Source of truth for project state
2. **Verify against filesystem** - Don't trust state files blindly
3. **Report current blockers** - Tell user what's preventing progress
4. **Check task status** - Don't repeat what's done
5. **Never assume completion** - Only user can verify tests work

### State File Rules
- Machine-readable JSON format (no ambiguity)
- Updated after EVERY significant action
- Cross-verified with actual system state
- Tracks blockers explicitly
- Records what's tested vs what's "done"

## ðŸŽ¯ The Vision

**Beacon Network is the MVP funnel for StackDock.**

- Provides immediate value (global uptime monitoring)
- Demonstrates intelligent correlation (user errors vs provider status)
- Creates upgrade pressure (credit limits)
- Uses all sponsor technologies meaningfully

**This is a hackathon submission. Don't fuck it up.**

## ðŸ“ž When In Doubt

1. Read `project-plan.md` first
2. Check `project-state/` JSON files
3. Review existing patterns in the codebase
4. Read the architecture docs
5. Ask the user (don't assume)
6. Preserve > Delete
7. Document > Assume
8. Verify > Trust

---

**Remember: This is a hackathon submission due November 14th. Every decision matters. Standards will be followed. No exception.**
